- name: Login to registry (docker CLI)
  ansible.builtin.shell: >
    echo "{{ lookup('env','DOCKER_PASS') }}" | docker login registry.example.com -u "{{ lookup('env','DOCKER_USER') }}" --password-stdin
  changed_when: false

- name: Build docker image
  community.docker.docker_image:
    build:
      path: "{{ playbook_dir }}/../"    # repo root (contains Dockerfile)
    name: "{{ image_name }}"
    tag: "{{ image_tag }}"
    force_source: true

- name: Push image to registry
  community.docker.docker_image:
    name: "{{ image_name }}"
    tag: "{{ image_tag }}"
    push: true

