- name: Replace image tag in deployment manifest
  ansible.builtin.replace:
    path: "{{ playbook_dir }}/../k8s/deployment.yaml"
    regexp: 'IMAGE_TAG_PLACEHOLDER'
    replace: "{{ image_tag }}"

- name: Validate deployment manifest locally
  ansible.builtin.shell: |
    kubectl apply -f {{ playbook_dir }}/../k8s/deployment.yaml --kubeconfig="{{ kubeconfig }}" --dry-run=client
  changed_when: false

- name: Apply Kubernetes deployment manifest
  ansible.builtin.shell: |
    kubectl apply -f {{ playbook_dir }}/../k8s/deployment.yaml --kubeconfig="{{ kubeconfig }}" --validate=false
  changed_when: true

- name: Validate service manifest locally
  ansible.builtin.shell: |
    kubectl apply -f {{ playbook_dir }}/../k8s/service.yaml --kubeconfig="{{ kubeconfig }}" --dry-run=client
  changed_when: false

- name: Apply Kubernetes service manifest
  ansible.builtin.shell: |
    kubectl apply -f {{ playbook_dir }}/../k8s/service.yaml --kubeconfig="{{ kubeconfig }}" --validate=false
  changed_when: true

- name: Validate ingress manifest locally
  ansible.builtin.shell: |
    kubectl apply -f {{ playbook_dir }}/../k8s/ingress.yaml --kubeconfig="{{ kubeconfig }}" --dry-run=client
  changed_when: false

- name: Apply Kubernetes ingress manifest
  ansible.builtin.shell: |
    kubectl apply -f {{ playbook_dir }}/../k8s/ingress.yaml --kubeconfig="{{ kubeconfig }}" --validate=false
  changed_when: true


