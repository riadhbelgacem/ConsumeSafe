- name: Replace image tag in deployment manifest
  ansible.builtin.replace:
    path: "{{ playbook_dir }}/../k8s/deployment.yaml"
    regexp: 'IMAGE_TAG_PLACEHOLDER'
    replace: "{{ image_tag }}"

- name: Apply Kubernetes deployment manifest
  ansible.builtin.shell: |
    KUBECONFIG=~/.kube/config kubectl apply -f {{ playbook_dir }}/../k8s/deployment.yaml --insecure-skip-tls-verify --validate=false
  changed_when: true
  ignore_errors: yes

- name: Apply Kubernetes service manifest
  ansible.builtin.shell: |
    KUBECONFIG=~/.kube/config kubectl apply -f {{ playbook_dir }}/../k8s/service.yaml --insecure-skip-tls-verify --validate=false
  changed_when: true
  ignore_errors: yes

- name: Apply Kubernetes ingress manifest
  ansible.builtin.shell: |
    KUBECONFIG=~/.kube/config kubectl apply -f {{ playbook_dir }}/../k8s/ingress.yaml --insecure-skip-tls-verify --validate=false
  changed_when: true
  ignore_errors: yes

- name: Display deployment status
  ansible.builtin.debug:
    msg: "Kubernetes deployment attempted. Check cluster manually if needed: kubectl get pods -n default"


